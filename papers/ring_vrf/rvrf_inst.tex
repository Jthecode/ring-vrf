
\section{Zero-knowledge continuations}
\label{sec:rvrf_cont}

\newcommand\rrSNARK{\primalgo{Groth16}\xspace}
\newcommand\pifast{\ensuremath{\pi_{\mathtt{fast}}}}
\newcommand\pisafe{\ensuremath{\pi_{\mathtt{safe}}}}

We now construct ring VRFs which achieves fast amortized prover time
by using a heavy zero-knowledge continuation for $\rVRF.\OpenKey$ but
which permits updating \openpk in the $\PedVRF.\OpenKey$ invokation
without reproving $\pi$.
$$ \pi = \NIZK \Setst{ \compk, \comring }{
 \exists \openpk,\openring \textrm{\ s.t.\ } 
 \genfrac{}{}{0pt}{}{\PedVRF.\OpenKey(\compk,\openpk) \quad}{\,\, = \rVRF.\OpenKey(\comring,\openring)}
} \mathperiod $$

% \smallskip
\subsection{Rerandomization}
% \label{sec:rvrf_groth16}

Zero-knowledge continuations need rerandomizable zkSNARKs
when being reused multiple times, meaning Groth16 \cite{groth16},
but unlinkability requires more than merely rerandomization.

In Groth16 \cite{groth16}, we have an SRS $S$ consisting of curve
points in $\grE_1$ and $\grE_2$ that encode the circuit being proven.
We follow \cite{groth16} in discussing the SRS $S$ in terms of
its ``toxic waste''
 $(\alpha,\beta,\delta,\gamma,\tau^1,\tau^2,\ldots) \in \F_q^*$.
In other words, we could write say $[ f(\tau)/\delta ]_1$ or $[\cdots]_2$
to denote an element of our SRS $S$ in $\grE_1$ or $\grE_2$ respectively,
computed by scalar multiplication from the toxic waste $\tau$ and $\delta$,
 but for which nobody knows the underlying $\tau$ or $\delta$ anymore.

In the SRS $S$, we distinguish the verifiers' string of elements
 $Y_1,\ldots,Y_k, [\alpha]_1 \in \grE_1$ and
 $[\beta]_2, [\gamma]_2, [\delta]_2 \in \grE_2$.
% as seperate from the provers' much longer string of elements in $\grE_1$ and $\grE_2$.
A Groth16 \cite{groth16} proof then takes the form 
 $\pi = (A,B,C) \in \grE_1 \times \grE_2 \times \grE_1$.
A verifier then produces a $X = \sum_i^k x_i Y_i \in \grE_1$ from
 the public inputs $x_i$ and then checks 
$$ e(A,B) = e([\alpha]_1, [\beta]_2) \cdot
 e(X, [\gamma]_2) \cdot e(C, [\delta]_2) \mathperiod $$

We need the rerandomization algorithm from \cite[Fig.~1]{RandomizationGroth16}:
% to build a zero-knowlege continuation:
% https://eprint.iacr.org/2020/811
% https://github.com/arkworks-rs/groth16/pull/16/files
% \algo{rerandomize}
An existing SNARK $(A,B,C)$ is transformed into a fresh
SNARK $(A',B',C')$ by sampling random $r_1,r_2 \in \F_p$ and computing
$$ \begin{aligned}
A' &= {1 \over r_1} A \\
B' &= r_1 B + r_1 r_2 [\delta]_2 \\
C' &= C + r_2 A \mathperiod \\
\end{aligned} $$
At this point, our $x_i$ remain identical after rerandomization,
so $X$ links $(A,B,C)$ to $(A',B',C')$.
Alone rerandomization cannot alter public inputs $x_i$, so
we instead need an opaque public input point $X$, which then becomes
part of our proof and incurs its own seperate proof of correctness.

We also need one fresh basepoint $\genB_\gamma$ independent from all others,
again perhaps created by applying $H_\grE$ to an input outside existing usages' domain.
We now give provers the additional SRS elements
$$ \genB_\delta := {\gamma\over\delta} \genB_\gamma $$
Although $\genB_\gamma$ is independent, 
we create $\genB_\delta$ during the trusted setup,
 so the toxic waste $\gamma$ and $\delta$ remain secret.
After this, subversion resistance could be checked like 
$$ e(\genB_\gamma, [\gamma]_2) = e(\genB_\delta, [\delta]_2) \mathperiod $$

We now have a zero-knowledge continuation $(X,A,B,C)$ from which
we produce an unlinkable $(X',A',B',C')$ by
 first sampling random $b,r_1,r_2 \in \F_p$ and then computing
$$ \begin{aligned}
X' &= X + b \genB_\gamma \\
A' &= {1 \over r_1} A \\
B' &= r_1 B + r_1 r_2 [\delta]_2 \\
C' &= C + r_2 A + b \genB_\delta \mathperiod \\
\end{aligned} $$
As our two $b$ terms cancel in the pairings, we wind up with the standard Groth16
 rerandomization construction above, except with $X$ opaque.

We still verify $(X',A',B',C')$ like 
$$ e(A',B') = e([\alpha]_1, [\beta]_2) \cdot
 e(X', [\gamma]_2) \cdot e(C', [\delta]_2) \mathcomma $$
As our verifier does not build $X$ themselves, we proves nothing
with this pairing equation unless the verifier seperately checks
 some proof-of-knowledge that $X' = \sum_i^k x_i Y_i$.
We foresee some $x_i$ being transperent elements that determine the
Merkle root of the ring $\ctx$, but any $x_i$ concerning the
 specific $\pk$ must be hidded by out blinding terms in $b$.

All told, our rerandomization trick transforms some conventional
Groth16 SNARK $\pi_{\mathtt{inner}}$ for $\rVRF.\OpenKey$
into a SNARK $\pi$ with an opaque and unlinkable input $X$.
We therefore explore two concrete $\pi_{\mathtt{inner}}$ proposals next.

Importantly, rerandomization requires only
 four scalar multplicaitons on $\ecE_1$ and
 two scalar multplicaitons on $\ecE_2$,
which  BLS12 curves make roughly equivlent to
 eight scalar multplicaitons on $\ecE_1$.

% Intutitively, an adversary cannot link $(X,A,B,C)$ with $(X',A',B',C')$ because 

\begin{proposition}\label{prop:unlinkable}
Let $\sigma$ and $\sigma'$ denote Chaum-Pedersen proofs-of-knowledge
 for $X$ and $X'$ respectively, with nonces chosen randomly.
Then $(X,A,B,C,\sigma)$ and $(X',A',B',C',\sigma')$ are unlinkable.
\end{proposition}

\begin{proof}[Proof stetch.]
???
\end{proof}

\subsection{Faster}
\label{subsec:rvrf_faster}

We describe the preferred faster choice $\pifast$ for $\pi_{\mathtt{inner}}$
that sets $x_1 := \sk$ and $x_0 = \CommitRing(\ctx)$ so that
taking $\genG := Y_1$, $\genB := \genB_\gamma$, and $\openpk := b$ in \PedVRF
yields and incredible fast amortized ring VRF prover.
Also, \PedVRF itself proves knowledge of $X$.
$$ X = \CommitRing(\ctx)\, Y_0 + \sk\, Y_1 + b \genB_\gamma $$

A priori, we do not know $Y_1$ during the trusted setup for $\pifast$,
which prevents computing $\pk = \sk\, Y_1$ inside $\pifast$.
Instead, we propose $\ctx$ contain commitments to $\sk$ over
some Jubjub curve $\ecJ$.  

We know $\grJ$ typically has smaller order than $\grE$,
due to $\ecJ$ being an Edwards curve, but 
if $\sk = \sk_0 + \sk_1 \, 2^{128}$ then our public key commitments could
take the form $\sk_0\, \genJ_0 + \sk_1\, \genJ_1 + b' \genJ_2$,
with independent $\genJ_0,\genJ_1,\genJ_2$.
Interestingly, we avoid range proofs for $\sk_1$ and $\sk_2$
by this independence. 

$$ \pifast = \rrSNARK \Setst{ \sk_0 + \sk_1 2^128, \comring }{
 \exists b',\openring \textrm{\ s.t.\ }
 % 0 < \sk_0,\sk_1 < 2^128 \textrm{\ and\ } 
 \genfrac{}{}{0pt}{}{\rVRF.\OpenKey(\comring,\openring)}{\,\, = \sk_0 \genJ_0 + \sk_1 \genJ_1 + b' \genJ_2}
} $$ % \mathperiod 

We explain later in \S\ref{sec:ring_hiding} how one could
choose $Y_1$ independent before doing the trusted setup,
 and then wire $Y_1$ into $\pifast$ inside $C$.
In ths case, we could prove $\pk = \sk\, Y_1$ inside $\pifast$, but then
non-native arithmetic makes $\pifast$ far slower.

At this point, \PedVRF requires four scalar multiplications on $\ecE_1$,
so together with rerandomization our amortized prover time
 approaches 12 scalar multiplications on typical curves. 
We expect the three pairings dominate verifier time.

As an aside, one could construct a second faster curve with the same
group order as $\grE$, which speeds up one scalar multiplication
 in both the prover and verifier. 

Importantly, our fast ring VRF' amortized prover time now rivals
group signature schemes' performance.  We hope this ends the temptation
to deploy group signature like constructions where the deanonymization vectors matter.

\begin{proposition}\label{prop:pifast_anonymity}
\rVRF using \pifast satisfies ring anonymity.
\end{proposition}

\begin{proof}[Proof stetch.]
???
\end{proof}

\subsection{Safer}

Although blindingly fast, we processed $\sk$ directly inside $\pifast$,
which annoys those wanting lightweight HSM provers, and
increases side channel attack risks.

We could easily build a safer circuit in which
\PedVRF runs on, and $\pk$ lies in, the Jubjub curve $\ecJ$, like 
$$ \pisafe = \rrSNARK \Setst{ \pk, \comring }{
 \exists \openring \textrm{\ s.t.\ }
 \pk = \rVRF.\OpenKey(\comring,\openring)
} \mathperiod $$
In this, our $\genG$ and $\genB$ have no relation with $\ecE$ or \pisafe,
so our $X$ nolonger plays less nicely with \PedVRF, 
$$ X = \CommitRing(\ctx) Y_0 + \pk.x Y_1 + \pk.y Y_2 + b \genB_\gamma \mathperiod $$

Instead we strip the blinding $b \genB_\gamma$ using a second SNARK $\pisafe'$.
As our second SNARK $\pisafe'$ cannot be another zero-knowledge continuation
itself, because it knows the $\openpk$ of \PedVRF.
Yet, we keep $\pisafe'$ working on $\ecE$ by reusing the external blinding
trick again.  In other works, we construct an inner SNARK $\pisafe'$ with
its own $\delta'$ and $\gamma'$ and that processes
 transperent public inputs $\compk.x Y'_1 + \compk.y Y'_2$ and an opaque
$$ X' = \pk.x Y'_3 + \pk.y Y'_4 + b \genB_{\gamma'} \mathperiod $$

We need $\pisafe'$ to apply the $\ecJ$ blinding required by \PedVRF
ala $\pk = \PedVRF.\OpenKey(\compk,\openpk) = \compk - \openpk \genB$, so
$$ \pisafe' = \rrSNARK \Setst{ \compk, \pk }{
 \exists \openpk \textrm{\ s.t.\ } \compk = \pk + \openpk \genB
} \mathperiod $$
In this, we nolonger prove knowledge of $X$ in \PedVRF like $\pifast$ did.
Instead, we employ another Chaum-Pedersen DLEQ proof to wire
 the $X$ of $\pisafe$ to the $X'$ of $\pisafe'$,
 thus proving knowledge of both.
We cannot avoid this proof-of-knowledge, but it becomes simpler if
we choose $Y'_3 = Y_1$ and $Y'_4 = Y_2$ using the trick of \S\ref{sec:ring_hiding}.

We take $\aux \doubleplus \pisafe \doubleplus \pisafe'$
 to be the \aux of \PedVRF of course.

\begin{proposition}\label{prop:pisafe_anonymity}
\rVRF using \pisafe satisfies ring anonymity.
\end{proposition}

\begin{proof}[Proof stetch.]
???
\end{proof}

% \smallskip

As \openpk appears inside $\pisafe'$, we recompute $\pisafe'$ with
every ring VRF signature, but the elliptic curve addition requires
only 5ish constraints, and the elliptic curve scalar multiplication
requires under 750 ??? constraints. 
All told our amortized prover runs faster than a Groth16 prover
with 800 constraints.

A priori, our safer verifier requires five pairings, along with
some additional $\ecE_1$ scalar multiplications.
We conjecture $\gamma$ and $\delta$ could safely be shared between
$\pisafe$ and $\pisafe'$, thereby requiring only four pairings,
but caution this result appars non-trivial.

% \smallskip

